#!/bin/bash

# Linch Mind ç»Ÿä¸€ç®¡ç†è„šæœ¬
# ç”¨æ³•:
#   ./linch start       - å¯åŠ¨daemonå’ŒUI
#   ./linch daemon      - daemonç®¡ç† (start/stop/restart/status/logs)
#   ./linch ui          - å¯åŠ¨UI (å¯æŒ‡å®šå¹³å°)
#   ./linch stop        - åœæ­¢æ‰€æœ‰æœåŠ¡
#   ./linch status      - æŸ¥çœ‹çŠ¶æ€
#   ./linch init        - åˆå§‹åŒ–ç¯å¢ƒ
#   ./linch doctor      - ç³»ç»Ÿè¯Šæ–­
#   ./linch reset       - é‡ç½®ç¯å¢ƒ

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# è·å–é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DAEMON_DIR="$PROJECT_ROOT/daemon"
UI_DIR="$PROJECT_ROOT/ui"
RUNTIME_DIR="$HOME/.linch-mind"
PID_FILE="$RUNTIME_DIR/daemon.pid"

# ç¡®ä¿è¿è¡Œæ—¶ç›®å½•å­˜åœ¨
mkdir -p "$RUNTIME_DIR"

# æ˜¾ç¤ºLogo
show_logo() {
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘            Linch Mind                â•‘"
    echo "â•‘     Personal AI Life Assistant      â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ˜¾ç¤ºä½¿ç”¨æ–¹æ³•
show_usage() {
    show_logo
    echo -e "${BLUE}Linch Mind ç»Ÿä¸€ç®¡ç†è„šæœ¬${NC}"
    echo ""
    echo "ç”¨æ³•: $0 <command> [options]"
    echo ""
    echo "ä¸»è¦å‘½ä»¤:"
    echo "  start           - å¯åŠ¨daemonå’ŒUI"
    echo "  stop            - åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  status          - æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€"
    echo "  init            - åˆå§‹åŒ–ç¯å¢ƒï¼ˆé¦–æ¬¡ä½¿ç”¨æˆ–åˆ‡æ¢ç¯å¢ƒï¼‰"
    echo "  doctor          - ç³»ç»Ÿå¥åº·è¯Šæ–­"
    echo "  reset           - é‡ç½®ç¯å¢ƒæ•°æ®ï¼ˆå±é™©æ“ä½œï¼‰"
    echo ""
    echo "Daemonç®¡ç†:"
    echo "  daemon start    - å¯åŠ¨daemon"
    echo "  daemon stop     - åœæ­¢daemon"
    echo "  daemon restart  - é‡å¯daemon"
    echo "  daemon status   - daemonçŠ¶æ€"
    echo "  daemon logs     - æŸ¥çœ‹daemonæ—¥å¿—"
    echo ""
    echo "UIç®¡ç†:"
    echo "  ui [platform]   - å¯åŠ¨UI (é»˜è®¤: macos)"
    echo "                    æ”¯æŒ: macos, linux, windows, web, android, ios"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 start              # å¯åŠ¨å®Œæ•´åº”ç”¨"
    echo "  $0 daemon start       # åªå¯åŠ¨daemon"
    echo "  $0 ui web             # å¯åŠ¨Webç‰ˆUI"
    echo "  $0 stop               # åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo ""
}

# æ£€æŸ¥ç¯å¢ƒ
check_environment() {
    # æ£€æŸ¥daemonç›®å½•
    if [ ! -d "$DAEMON_DIR" ]; then
        echo -e "${RED}âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°daemonç›®å½•${NC}"
        exit 1
    fi

    # æ£€æŸ¥Poetryï¼ˆdaemonéœ€è¦ï¼‰
    if ! command -v poetry &> /dev/null; then
        echo -e "${RED}âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°Poetry${NC}"
        echo -e "${YELLOW}   å®‰è£…ï¼šcurl -sSL https://install.python-poetry.org | python3 -${NC}"
        exit 1
    fi

    # æ£€æŸ¥Flutterï¼ˆUIéœ€è¦ï¼‰
    if [ "$1" = "ui" ] && ! command -v flutter &> /dev/null; then
        echo -e "${RED}âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°Flutter${NC}"
        echo -e "${YELLOW}   å®‰è£…ï¼šhttps://flutter.dev/docs/get-started/install${NC}"
        exit 1
    fi
}

# è·å–daemonè¿›ç¨‹ID
get_daemon_pid() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 $PID 2>/dev/null; then
            echo $PID
        else
            rm -f "$PID_FILE"
            echo ""
        fi
    else
        echo ""
    fi
}

# å¯åŠ¨daemon
start_daemon() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨ Daemon...${NC}"

    EXISTING_PID=$(get_daemon_pid)
    if [ ! -z "$EXISTING_PID" ]; then
        echo -e "${YELLOW}âš ï¸  Daemonå·²è¿è¡Œ (PID: $EXISTING_PID)${NC}"
        return 0
    fi

    cd "$DAEMON_DIR"
    # è·³è¿‡ä¾èµ–æ£€æŸ¥ï¼Œæˆ–ä½¿ç”¨--no-interactioné¿å…å¡ä½
    # echo -e "${BLUE}ğŸ“¦ æ£€æŸ¥ä¾èµ–...${NC}"
    # poetry install --only=main --quiet --no-interaction

    echo -e "${GREEN}âœ… å¯åŠ¨daemonæœåŠ¡...${NC}"
    # ä½¿ç”¨è¿è¡Œæ—¶ç›®å½•çš„æ—¥å¿—æ–‡ä»¶
    nohup poetry run linch-daemon > "$RUNTIME_DIR/daemon.log" 2>&1 &

    DAEMON_PID=$!
    # ä¸å†ç”±è„šæœ¬åˆ›å»ºPIDæ–‡ä»¶ï¼Œè®©daemonè‡ªå·±ç®¡ç†
    # echo -e "${BLUE}   ä¿å­˜PID: $DAEMON_PID åˆ° $PID_FILE${NC}"
    # echo $DAEMON_PID > "$PID_FILE"

    # ç­‰å¾…daemonè‡ªå·±åˆ›å»ºPIDæ–‡ä»¶
    sleep 3

    # æ£€æŸ¥daemonæ˜¯å¦æˆåŠŸå¯åŠ¨ï¼ˆé€šè¿‡æ£€æŸ¥PIDæ–‡ä»¶ï¼‰
    if [ -f "$PID_FILE" ]; then
        ACTUAL_PID=$(cat "$PID_FILE")
        if kill -0 $ACTUAL_PID 2>/dev/null; then
            echo -e "${GREEN}âœ… Daemonå¯åŠ¨æˆåŠŸ (PID: $ACTUAL_PID)${NC}"
            # ç­‰å¾…IPC socketæ–‡ä»¶ç”Ÿæˆ
            for i in {1..10}; do
                if [ -f "$HOME/.linch-mind/daemon.socket" ]; then
                    echo -e "${BLUE}   IPC: Unix Domain Socket å·²å°±ç»ª${NC}"
                    break
                fi
                sleep 1
            done
        else
            echo -e "${RED}âŒ Daemonè¿›ç¨‹æœªè¿è¡Œ${NC}"
            rm -f "$PID_FILE"
            exit 1
        fi
    else
        echo -e "${RED}âŒ Daemonå¯åŠ¨å¤±è´¥ï¼ˆæ— PIDæ–‡ä»¶ï¼‰${NC}"
        exit 1
    fi
}

# åœæ­¢daemon
stop_daemon() {
    echo -e "${BLUE}ğŸ›‘ åœæ­¢ Daemon...${NC}"

    DAEMON_PID=$(get_daemon_pid)
    if [ -z "$DAEMON_PID" ]; then
        echo -e "${YELLOW}âš ï¸  Daemonæœªè¿è¡Œ${NC}"
        return 0
    fi

    if kill -TERM $DAEMON_PID 2>/dev/null; then
        for i in {1..10}; do
            if ! kill -0 $DAEMON_PID 2>/dev/null; then
                echo -e "${GREEN}âœ… Daemonå·²åœæ­¢${NC}"
                rm -f "$PID_FILE"
                return 0
            fi
            sleep 1
        done
        kill -KILL $DAEMON_PID 2>/dev/null || true
        echo -e "${GREEN}âœ… Daemonå·²å¼ºåˆ¶åœæ­¢${NC}"
    fi
    rm -f "$PID_FILE"
}

# daemonçŠ¶æ€
daemon_status() {
    DAEMON_PID=$(get_daemon_pid)
    if [ ! -z "$DAEMON_PID" ]; then
        echo -e "${GREEN}âœ… Daemonè¿è¡Œä¸­${NC}"
        echo -e "${BLUE}   PID: $DAEMON_PID${NC}"

        # ä»socketæ–‡ä»¶æ£€æŸ¥IPCçŠ¶æ€ - æ”¯æŒç¯å¢ƒç‰¹å®šè·¯å¾„
        SOCKET_PATHS=(
            "$HOME/.linch-mind/daemon.socket"
            "$HOME/.linch-mind/development/data/daemon.socket"
            "$HOME/.linch-mind/production/data/daemon.socket"
            "$HOME/.linch-mind/staging/data/daemon.socket"
        )
        
        socket_found=false
        for socket_path in "${SOCKET_PATHS[@]}"; do
            if [ -S "$socket_path" ]; then
                echo -e "${BLUE}   IPC: Unix Domain Socket å¯ç”¨${NC}"
                echo -e "${GREEN}   Socketè·¯å¾„: $socket_path${NC}"
                echo -e "${GREEN}   é€šä¿¡çŠ¶æ€: IPCè¿æ¥å°±ç»ª${NC}"
                socket_found=true
                break
            fi
        done
        
        if [ "$socket_found" = false ]; then
            echo -e "${YELLOW}   IPCä¿¡æ¯æœªæ‰¾åˆ°${NC}"
        fi
    else
        echo -e "${RED}âŒ Daemonæœªè¿è¡Œ${NC}"
    fi
}

# æŸ¥çœ‹daemonæ—¥å¿—
daemon_logs() {
    LOG_FILE="$RUNTIME_DIR/daemon.log"
    if [ -f "$LOG_FILE" ]; then
        echo -e "${BLUE}ğŸ“‹ Daemonæ—¥å¿—:${NC}"
        tail -n 50 "$LOG_FILE"
    else
        echo -e "${YELLOW}âš ï¸  æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨${NC}"
    fi
}

# å¯åŠ¨UI
start_ui() {
    local platform=${1:-macos}

    echo -e "${BLUE}ğŸš€ å¯åŠ¨ UI ($platform)...${NC}"

    # æ£€æŸ¥daemon IPCè¿æ¥
    if [ -f "$HOME/.linch-mind/daemon.socket" ]; then
        echo -e "${GREEN}   âœ… Daemon IPCè¿æ¥å¯ç”¨${NC}"
    else
        echo -e "${YELLOW}   âš ï¸  Daemon IPC socketæœªæ‰¾åˆ°${NC}"
        echo -e "${YELLOW}   è¯·å…ˆè¿è¡Œ: $0 daemon start${NC}"
    fi

    cd "$UI_DIR"
    echo -e "${BLUE}ğŸ“¦ è·å–Flutterä¾èµ–...${NC}"
    flutter pub get

    case $platform in
        macos) flutter run -d macos ;;
        linux) flutter run -d linux ;;
        windows) flutter run -d windows ;;
        web) flutter run -d web-server --web-port 8080 ;;
        android) flutter run -d android ;;
        ios) flutter run -d ios ;;
        *)
            echo -e "${RED}âŒ ä¸æ”¯æŒçš„å¹³å°: $platform${NC}"
            echo -e "${YELLOW}æ”¯æŒ: macos, linux, windows, web, android, ios${NC}"
            exit 1 ;;
    esac
}

# å¯åŠ¨å®Œæ•´åº”ç”¨
start_full() {
    show_logo
    echo -e "${BLUE}ğŸš€ å¯åŠ¨å®Œæ•´åº”ç”¨...${NC}"
    echo ""

    start_daemon
    echo ""
    echo -e "${BLUE}ç­‰å¾…daemonå®Œå…¨å¯åŠ¨...${NC}"
    sleep 3
    start_ui
}

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop_all() {
    show_logo
    stop_daemon
}

# æ˜¾ç¤ºå®Œæ•´çŠ¶æ€
show_full_status() {
    show_logo
    daemon_status
}

# åˆå§‹åŒ–ç¯å¢ƒ
init_environment() {
    local env_name=${1:-""}
    local force_flag=""

    show_logo
    echo -e "${BLUE}ğŸ”§ ç¯å¢ƒåˆå§‹åŒ–...${NC}"
    echo ""

    # æ£€æŸ¥ç¯å¢ƒå‚æ•°
    if [[ $# -gt 1 && "$2" == "--force" ]]; then
        force_flag="--force"
        echo -e "${YELLOW}âš ï¸  å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–æ¨¡å¼${NC}"
    fi

    if [ ! -z "$env_name" ]; then
        echo -e "${BLUE}ç›®æ ‡ç¯å¢ƒ: $env_name${NC}"
        export LINCH_ENV="$env_name"
    else
        echo -e "${BLUE}ä½¿ç”¨å½“å‰ç¯å¢ƒï¼ˆé€šè¿‡LINCH_ENVç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰${NC}"
    fi

    cd "$DAEMON_DIR"
    echo -e "${GREEN}ğŸš€ æ‰§è¡Œç¯å¢ƒåˆå§‹åŒ–...${NC}"

    if poetry run python scripts/initialize_environment.py --env "$env_name" $force_flag; then
        echo ""
        echo -e "${GREEN}âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ${NC}"
        echo -e "${BLUE}ğŸ’¡ æç¤ºï¼š${NC}"
        echo -e "${BLUE}   - ä½¿ç”¨ '$0 start' å¯åŠ¨åº”ç”¨${NC}"
        echo -e "${BLUE}   - ä½¿ç”¨ '$0 doctor' éªŒè¯ç³»ç»Ÿå¥åº·${NC}"
    else
        echo -e "${RED}âŒ ç¯å¢ƒåˆå§‹åŒ–å¤±è´¥${NC}"
        echo -e "${YELLOW}ğŸ’¡ å°è¯•ï¼š${NC}"
        echo -e "${YELLOW}   - æ£€æŸ¥æ—¥å¿—: $0 daemon logs${NC}"
        echo -e "${YELLOW}   - å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–: $0 init --force${NC}"
        exit 1
    fi
}

# ç³»ç»Ÿè¯Šæ–­
run_doctor() {
    show_logo
    echo -e "${BLUE}ğŸ©º ç³»ç»Ÿå¥åº·è¯Šæ–­...${NC}"
    echo ""

    # è®¡æ•°å™¨
    local checks_passed=0
    local total_checks=0

    # æ£€æŸ¥1: Poetryç¯å¢ƒ
    total_checks=$((total_checks + 1))
    if command -v poetry &> /dev/null; then
        echo -e "${GREEN}âœ… Poetry: å·²å®‰è£…${NC}"
        checks_passed=$((checks_passed + 1))
    else
        echo -e "${RED}âŒ Poetry: æœªæ‰¾åˆ°${NC}"
    fi

    # æ£€æŸ¥2: Flutterç¯å¢ƒï¼ˆå¯é€‰ï¼‰
    total_checks=$((total_checks + 1))
    if command -v flutter &> /dev/null; then
        echo -e "${GREEN}âœ… Flutter: å·²å®‰è£…${NC}"
        checks_passed=$((checks_passed + 1))
    else
        echo -e "${YELLOW}âš ï¸  Flutter: æœªå®‰è£…ï¼ˆUIåŠŸèƒ½å°†ä¸å¯ç”¨ï¼‰${NC}"
    fi

    # æ£€æŸ¥3: ç›®å½•ç»“æ„
    total_checks=$((total_checks + 1))
    if [ -d "$HOME/.linch-mind" ]; then
        echo -e "${GREEN}âœ… è¿è¡Œæ—¶ç›®å½•: å·²åˆ›å»º${NC}"
        checks_passed=$((checks_passed + 1))

        # æ£€æŸ¥ç¯å¢ƒç›®å½•
        local env_dir="$HOME/.linch-mind/${LINCH_ENV:-development}"
        if [ -d "$env_dir" ]; then
            echo -e "${GREEN}   å½“å‰ç¯å¢ƒç›®å½•: å·²åˆ›å»º ($env_dir)${NC}"
        else
            echo -e "${YELLOW}   å½“å‰ç¯å¢ƒç›®å½•: æœªæ‰¾åˆ° - éœ€è¦è¿è¡Œ '$0 init'${NC}"
        fi
    else
        echo -e "${RED}âŒ è¿è¡Œæ—¶ç›®å½•: æœªåˆ›å»º${NC}"
    fi

    # æ£€æŸ¥4: DaemonçŠ¶æ€
    total_checks=$((total_checks + 1))
    local daemon_pid=$(get_daemon_pid)
    if [ ! -z "$daemon_pid" ]; then
        echo -e "${GREEN}âœ… DaemonæœåŠ¡: è¿è¡Œä¸­ (PID: $daemon_pid)${NC}"
        checks_passed=$((checks_passed + 1))

        # æ£€æŸ¥IPCè¿æ¥
        if [ -f "$HOME/.linch-mind/daemon.socket" ]; then
            echo -e "${GREEN}   IPCè¿æ¥: å¯ç”¨${NC}"
        else
            echo -e "${YELLOW}   IPCè¿æ¥: æœªæ‰¾åˆ°socketæ–‡ä»¶${NC}"
        fi
    else
        echo -e "${YELLOW}âš ï¸  DaemonæœåŠ¡: æœªè¿è¡Œ${NC}"
    fi

    # æ£€æŸ¥5: æ•°æ®åº“æ–‡ä»¶
    total_checks=$((total_checks + 1))
    local db_env_dir="$HOME/.linch-mind/${LINCH_ENV:-development}/database"
    if [ -d "$db_env_dir" ] && [ -f "$db_env_dir/linch_mind"*".db" ]; then
        echo -e "${GREEN}âœ… æ•°æ®åº“: å·²åˆ›å»º${NC}"
        checks_passed=$((checks_passed + 1))
    else
        echo -e "${YELLOW}âš ï¸  æ•°æ®åº“: æœªæ‰¾åˆ° - éœ€è¦è¿è¡Œ '$0 init'${NC}"
    fi

    # è¿è¡ŒPythonè¯Šæ–­è„šæœ¬ï¼ˆå¦‚æœdaemonå¯ç”¨ï¼‰
    if [ ! -z "$daemon_pid" ]; then
        echo ""
        echo -e "${BLUE}ğŸ” è¿è¡Œæ·±åº¦è¯Šæ–­...${NC}"
        cd "$DAEMON_DIR"
        if poetry run python scripts/initialize_environment.py --list-envs 2>/dev/null; then
            echo -e "${GREEN}   Pythonç¯å¢ƒè¯Šæ–­: é€šè¿‡${NC}"
            checks_passed=$((checks_passed + 1))
        else
            echo -e "${YELLOW}   Pythonç¯å¢ƒè¯Šæ–­: è·³è¿‡ï¼ˆdaemonæœªå“åº”ï¼‰${NC}"
        fi
        total_checks=$((total_checks + 1))
    fi

    # è¯Šæ–­ç»“æœ
    echo ""
    echo -e "${BLUE}ğŸ“Š è¯Šæ–­ç»“æœ: ${checks_passed}/${total_checks} é¡¹æ£€æŸ¥é€šè¿‡${NC}"

    if [ $checks_passed -eq $total_checks ]; then
        echo -e "${GREEN}ğŸ‰ ç³»ç»Ÿå¥åº·çŠ¶æ€è‰¯å¥½ï¼${NC}"
        return 0
    elif [ $checks_passed -gt $((total_checks / 2)) ]; then
        echo -e "${YELLOW}âš ï¸  ç³»ç»ŸåŸºæœ¬å¥åº·ï¼Œä½†æœ‰ä¸€äº›é—®é¢˜éœ€è¦ä¿®å¤${NC}"
        echo -e "${BLUE}ğŸ’¡ å»ºè®®ï¼šè¿è¡Œ '$0 init' ä¿®å¤é…ç½®é—®é¢˜${NC}"
        return 1
    else
        echo -e "${RED}âŒ ç³»ç»Ÿå­˜åœ¨ä¸¥é‡é—®é¢˜${NC}"
        echo -e "${BLUE}ğŸ’¡ å»ºè®®ï¼š${NC}"
        echo -e "${BLUE}   1. è¿è¡Œ '$0 init --force' é‡æ–°åˆå§‹åŒ–${NC}"
        echo -e "${BLUE}   2. æ£€æŸ¥ä¾èµ–å®‰è£…ï¼šPoetry, Flutter${NC}"
        echo -e "${BLUE}   3. æ£€æŸ¥æ—¥å¿—ï¼š$0 daemon logs${NC}"
        return 2
    fi
}

# é‡ç½®ç¯å¢ƒ
reset_environment() {
    local env_name=${1:-$(echo ${LINCH_ENV:-development})}
    local confirm=${2:-""}

    show_logo
    echo -e "${RED}âš ï¸  ç¯å¢ƒé‡ç½® - å±é™©æ“ä½œ${NC}"
    echo ""
    echo -e "${YELLOW}è¿™å°†åˆ é™¤ç¯å¢ƒ '$env_name' çš„æ‰€æœ‰æ•°æ®ï¼š${NC}"
    echo -e "${YELLOW}  - æ•°æ®åº“${NC}"
    echo -e "${YELLOW}  - ç¼“å­˜æ–‡ä»¶${NC}"
    echo -e "${YELLOW}  - æ—¥å¿—æ–‡ä»¶${NC}"
    echo -e "${YELLOW}  - å‘é‡ç´¢å¼•${NC}"
    echo ""

    # å¦‚æœæ²¡æœ‰ç¡®è®¤å‚æ•°ï¼Œè¦æ±‚ç”¨æˆ·ç¡®è®¤
    if [[ "$confirm" != "--yes" && "$confirm" != "-y" ]]; then
        echo -e "${RED}è¯·è¾“å…¥ 'RESET' ç¡®è®¤é‡ç½®æ“ä½œï¼š${NC}"
        read -r user_input

        if [ "$user_input" != "RESET" ]; then
            echo -e "${BLUE}æ“ä½œå·²å–æ¶ˆ${NC}"
            return 0
        fi
    fi

    # åœæ­¢daemonï¼ˆå¦‚æœåœ¨è¿è¡Œï¼‰
    local daemon_pid=$(get_daemon_pid)
    if [ ! -z "$daemon_pid" ]; then
        echo -e "${YELLOW}ğŸ›‘ åœæ­¢è¿è¡Œä¸­çš„Daemon...${NC}"
        stop_daemon
    fi

    # åˆ é™¤ç¯å¢ƒæ•°æ®
    local env_dir="$HOME/.linch-mind/$env_name"
    if [ -d "$env_dir" ]; then
        echo -e "${RED}ğŸ—‘ï¸  åˆ é™¤ç¯å¢ƒæ•°æ®: $env_dir${NC}"
        rm -rf "$env_dir"
        echo -e "${GREEN}âœ… ç¯å¢ƒæ•°æ®å·²æ¸…ç†${NC}"
    else
        echo -e "${YELLOW}âš ï¸  ç¯å¢ƒç›®å½•ä¸å­˜åœ¨: $env_dir${NC}"
    fi

    echo ""
    echo -e "${GREEN}âœ… ç¯å¢ƒé‡ç½®å®Œæˆ${NC}"
    echo -e "${BLUE}ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š${NC}"
    echo -e "${BLUE}   è¿è¡Œ '$0 init' é‡æ–°åˆå§‹åŒ–ç¯å¢ƒ${NC}"
}

# ä¸»ç¨‹åº
main() {
    if [ $# -eq 0 ]; then
        show_usage
        exit 1
    fi

    case $1 in
        start)
            check_environment
            start_full
            ;;
        stop)
            stop_all
            ;;
        status)
            show_full_status
            ;;
        daemon)
            check_environment
            show_logo
            case ${2:-""} in
                start) start_daemon ;;
                stop) stop_daemon ;;
                restart) stop_daemon; sleep 2; start_daemon ;;
                status) daemon_status ;;
                logs) daemon_logs ;;
                *)
                    echo -e "${RED}âŒ daemonå­å‘½ä»¤: start|stop|restart|status|logs${NC}"
                    exit 1 ;;
            esac
            ;;
        ui)
            check_environment ui
            show_logo
            start_ui ${2:-macos}
            ;;
        init)
            check_environment
            init_environment "$2" "$3"
            ;;
        doctor)
            run_doctor
            ;;
        reset)
            reset_environment "$2" "$3"
            ;;
        help|--help|-h)
            show_usage
            ;;
        *)
            echo -e "${RED}âŒ æœªçŸ¥å‘½ä»¤: $1${NC}"
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
