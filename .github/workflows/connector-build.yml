name: ğŸ”— Connector Build

on:
  push:
    branches: [ main ]
    paths:
      - 'connectors/official/**'
      - 'connectors/community/**'

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd connectors
          pip install poetry pyyaml pyinstaller
          poetry install

      - name: Detect changes and bump versions
        id: detect
        run: |
          cd connectors
          
          # æ£€æµ‹å˜æ›´çš„è¿æ¥å™¨ï¼ˆæ”¯æŒofficialå’Œcommunityï¼‰
          changed_files=$(git diff --name-only HEAD~1 HEAD | grep -E '^connectors/(official|community)/' || true)
          
          if [ -z "$changed_files" ]; then
            echo "No connector changes detected"
            echo "changed_connectors=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå–è¿æ¥å™¨è·¯å¾„
          changed_connectors=""
          for file in $changed_files; do
            if [[ $file =~ ^connectors/(official|community)/([^/]+)/ ]]; then
              connector_type="${BASH_REMATCH[1]}"
              connector_name="${BASH_REMATCH[2]}"
              connector_path="$connector_type/$connector_name"
              changed_connectors="$changed_connectors $connector_path"
            fi
          done
          
          changed_connectors=$(echo "$changed_connectors" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
          echo "Changed connectors: $changed_connectors"
          echo "changed_connectors=$changed_connectors" >> $GITHUB_OUTPUT
          
          # ä½¿ç”¨å¤–éƒ¨è„šæœ¬è¿›è¡Œç‰ˆæœ¬ç®¡ç†
          for connector_path in $changed_connectors; do
            if [ -f "$connector_path/connector.json" ]; then
              echo "ğŸ”¢ Updating version for $connector_path"
              python scripts/version_manager.py "$connector_path/connector.json" --bump patch
            fi
          done

      - name: Build connectors  
        if: steps.detect.outputs.changed_connectors != ''
        run: |
          cd connectors
          mkdir -p release/dist
          
          # æ„å»ºå˜æ›´çš„è¿æ¥å™¨
          for connector_path in ${{ steps.detect.outputs.changed_connectors }}; do
            echo "ğŸš€ Building connector: $connector_path"
            
            if [ -f "$connector_path/connector.json" ] && [ -f "$connector_path/main.py" ]; then
              # è¯»å–è¿æ¥å™¨é…ç½®
              connector_id=$(python -c "import json; print(json.load(open('$connector_path/connector.json'))['id'])")
              echo "ğŸ“¦ Building $connector_id from $connector_path"
              
              # ä½¿ç”¨æ„å»ºè„šæœ¬
              python scripts/connector_builder.py "$connector_path" --output "release/dist" || {
                echo "âŒ Build failed for $connector_path, continuing with others..."
                continue
              }
            else
              echo "âš ï¸ Missing required files for $connector_path, skipping..."
            fi
          done

      - name: Generate registry
        if: steps.detect.outputs.changed_connectors != ''
        run: |
          cd connectors
          
          # ä½¿ç”¨å¤–éƒ¨è„šæœ¬ç”Ÿæˆæ³¨å†Œè¡¨
          python scripts/registry_generator.py --output release/registry.json --format

      - name: Commit changes
        if: steps.detect.outputs.changed_connectors != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add connectors/
          git commit -m "chore: auto-update connector versions [skip ci]

Updated connectors: ${{ steps.detect.outputs.changed_connectors }}

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
          git push

      - name: Create release tag
        if: steps.detect.outputs.changed_connectors != ''
        id: tag
        run: |
          # ç”ŸæˆåŸºäºæ—¶é—´æˆ³çš„releaseæ ‡ç­¾
          timestamp=$(date +%Y%m%d-%H%M%S)
          release_tag="connectors-v${timestamp}"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆreleaseå¤‡æ³¨
          release_notes="# ğŸ”— è¿æ¥å™¨å‘å¸ƒ v${timestamp}
          
          ## ğŸ“¦ æ›´æ–°çš„è¿æ¥å™¨
          ${{ steps.detect.outputs.changed_connectors }}
          
          ## ğŸ“‹ åŒ…å«å†…å®¹
          - è¿æ¥å™¨å¯æ‰§è¡Œæ–‡ä»¶ (å„å¹³å°)
          - è¿æ¥å™¨æ³¨å†Œè¡¨ (registry.json)
          - ç‰ˆæœ¬æ›´æ–°å’Œå˜æ›´è®°å½•
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          ä¸‹è½½å¯¹åº”å¹³å°çš„è¿æ¥å™¨å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‰ç…§æ–‡æ¡£é…ç½®å³å¯ä½¿ç”¨ã€‚
          
          ---
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)"
          
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$release_notes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.detect.outputs.changed_connectors != ''
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          release_name: "ğŸ”— è¿æ¥å™¨å‘å¸ƒ ${{ steps.tag.outputs.release_tag }}"
          body: ${{ steps.tag.outputs.release_notes }}
          draft: false
          prerelease: false

      - name: Upload release assets
        if: steps.detect.outputs.changed_connectors != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: connectors/release/registry.json
          asset_name: registry.json
          asset_content_type: application/json

      - name: Upload connector binaries
        if: steps.detect.outputs.changed_connectors != ''
        run: |
          # ä¸Šä¼ æ‰€æœ‰æ„å»ºçš„è¿æ¥å™¨äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -d "connectors/release/dist" ]; then
            for binary in connectors/release/dist/*; do
              if [ -f "$binary" ]; then
                echo "ğŸ“¦ Uploading binary: $(basename "$binary")"
                gh release upload ${{ steps.tag.outputs.release_tag }} "$binary" --clobber
              fi
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (backup)
        if: steps.detect.outputs.changed_connectors != ''
        uses: actions/upload-artifact@v3
        with:
          name: connectors-release-${{ steps.tag.outputs.release_tag }}
          path: |
            connectors/release/dist/
            connectors/release/registry.json