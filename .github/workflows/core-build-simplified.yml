# ðŸš€ ç®€åŒ–çš„æ ¸å¿ƒæž„å»ºå·¥ä½œæµ - æ¼”ç¤ºç‰ˆæœ¬
# ç›®æ ‡: å°†åŽŸæœ‰7ä¸ªå·¥ä½œæµåˆå¹¶ä¸º3ä¸ªæ ¸å¿ƒå·¥ä½œæµä¹‹ä¸€

name: ðŸ”§ Core Build Pipeline (Simplified)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

# ä»Žç»Ÿä¸€é…ç½®è¯»å–ç‰ˆæœ¬ä¿¡æ¯
env:
  FLUTTER_VERSION: "3.24.3"  # å°†æ”¹ä¸ºä»Žconfig/versions.ymlè¯»å–
  PYTHON_VERSION: "3.11"     # å°†æ”¹ä¸ºä»Žconfig/versions.ymlè¯»å–

jobs:
  # ðŸ” æ™ºèƒ½å˜æ›´æ£€æµ‹ - åˆå¹¶äº†æ‰€æœ‰åŽŸæœ‰çš„detect-changes jobs
  detect-changes:
    name: ðŸ” Smart Change Detection
    runs-on: ubuntu-latest
    outputs:
      build_flutter: ${{ steps.changes.outputs.flutter }}
      build_daemon: ${{ steps.changes.outputs.daemon }}
      build_connectors: ${{ steps.changes.outputs.connectors }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect component changes
        id: changes
        run: |
          # ç»Ÿä¸€çš„å˜æ›´æ£€æµ‹é€»è¾‘ - æ›¿ä»£äº†3ä¸ªé‡å¤çš„detect jobs
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          
          # Flutterå˜æ›´æ£€æµ‹
          if echo "$CHANGED_FILES" | grep -q '^ui/'; then
            echo "flutter=true" >> $GITHUB_OUTPUT
            echo "ðŸ“± Flutter changes detected"
          else
            echo "flutter=false" >> $GITHUB_OUTPUT
          fi
          
          # Daemonå˜æ›´æ£€æµ‹  
          if echo "$CHANGED_FILES" | grep -q '^daemon/'; then
            echo "daemon=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Daemon changes detected"
          else
            echo "daemon=false" >> $GITHUB_OUTPUT
          fi
          
          # Connectorså˜æ›´æ£€æµ‹
          if echo "$CHANGED_FILES" | grep -q '^connectors/'; then
            echo "connectors=true" >> $GITHUB_OUTPUT
            echo "ðŸ”Œ Connectors changes detected"
          else
            echo "connectors=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Extract version info
        id: version
        run: |
          # æ™ºèƒ½ç‰ˆæœ¬æå– - æ”¯æŒå¤šç»„ä»¶ç‰ˆæœ¬ç®¡ç†
          if [ "${{ steps.changes.outputs.flutter }}" = "true" ]; then
            VERSION=$(grep '^version:' ui/pubspec.yaml | sed 's/version: //')
          elif [ "${{ steps.changes.outputs.daemon }}" = "true" ]; then
            VERSION=$(grep '^version = ' daemon/pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          else
            VERSION="dev-$(date +%Y%m%d%H%M%S)"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Build version: $VERSION"

  # ðŸ—ï¸ å¹¶è¡Œè´¨é‡æ£€æŸ¥ - åˆå¹¶äº†æ‰€æœ‰quality-check jobs
  quality-check:
    name: ðŸ—ï¸ Parallel Quality Checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.build_flutter == 'true' || needs.detect-changes.outputs.build_daemon == 'true' || needs.detect-changes.outputs.build_connectors == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        component: 
          - ${{ needs.detect-changes.outputs.build_flutter == 'true' && 'flutter' || '' }}
          - ${{ needs.detect-changes.outputs.build_daemon == 'true' && 'daemon' || '' }}
          - ${{ needs.detect-changes.outputs.build_connectors == 'true' && 'connectors' || '' }}
        exclude:
          - component: ''
    
    steps:
      - uses: actions/checkout@v4
      
      # ðŸ”§ ç»Ÿä¸€çŽ¯å¢ƒè®¾ç½® - ä½¿ç”¨composite actionæ¨¡å¼ (å¾…å®žçŽ°)
      - name: Setup environment for ${{ matrix.component }}
        run: |
          case "${{ matrix.component }}" in
            flutter)
              echo "Setting up Flutter environment..."
              # Flutter setup logic
              ;;
            daemon)
              echo "Setting up Python environment..."
              pip install --upgrade pip
              cd daemon && pip install -e .
              ;;
            connectors)
              echo "Setting up Connectors environment..."
              cd connectors && pip install -e .
              ;;
          esac
      
      # ðŸ§ª ç»„ä»¶ç‰¹å®šè´¨é‡æ£€æŸ¥
      - name: Run quality checks for ${{ matrix.component }}
        run: |
          case "${{ matrix.component }}" in
            flutter)
              cd ui
              flutter pub get
              flutter analyze --fatal-infos
              dart format --set-exit-if-changed .
              flutter test --coverage
              ;;
            daemon)
              cd daemon
              python -m flake8 . --max-line-length=100
              python -m black --check .
              python -m pytest tests/ --cov=.
              ;;
            connectors)
              cd connectors
              python -m flake8 . --max-line-length=100
              python -m black --check .
              python -m pytest tests/ --cov=.
              ;;
          esac

  # ðŸ“¦ æ™ºèƒ½æž„å»º - åˆå¹¶äº†æ‰€æœ‰build jobsï¼Œä½¿ç”¨æ¡ä»¶æž„å»º
  smart-build:
    name: ðŸ“¦ Smart Build (${{ matrix.component }})
    runs-on: ${{ matrix.os }}
    needs: [detect-changes, quality-check]
    if: needs.detect-changes.outputs.build_flutter == 'true' || needs.detect-changes.outputs.build_daemon == 'true' || needs.detect-changes.outputs.build_connectors == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Flutteræž„å»ºçŸ©é˜µ - ç®€åŒ–ç‰ˆ
          - component: flutter
            os: ubuntu-latest
            platform: linux
            condition: ${{ needs.detect-changes.outputs.build_flutter == 'true' }}
          - component: flutter  
            os: macos-latest
            platform: macos
            condition: ${{ needs.detect-changes.outputs.build_flutter == 'true' }}
          - component: flutter
            os: windows-latest
            platform: windows
            condition: ${{ needs.detect-changes.outputs.build_flutter == 'true' }}
          
          # Daemonæž„å»ºçŸ©é˜µ
          - component: daemon
            os: ubuntu-latest
            platform: linux
            condition: ${{ needs.detect-changes.outputs.build_daemon == 'true' }}
          
          # Connectorsæž„å»ºçŸ©é˜µ - ç®€åŒ–ä¸ºä»…Linux
          - component: connectors
            os: ubuntu-latest
            platform: linux
            condition: ${{ needs.detect-changes.outputs.build_connectors == 'true' }}
        
        exclude:
          - condition: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build ${{ matrix.component }} for ${{ matrix.platform }}
        run: |
          echo "ðŸš€ Building ${{ matrix.component }} for ${{ matrix.platform }}"
          
          case "${{ matrix.component }}" in
            flutter)
              cd ui
              flutter build ${{ matrix.platform }} --release
              ;;
            daemon)
              cd daemon
              # Docker build for daemon
              echo "Building daemon service..."
              ;;
            connectors)
              cd connectors
              # ä½¿ç”¨ç®€åŒ–çš„è¿žæŽ¥å™¨æž„å»ºé€»è¾‘
              python scripts/build-all-connectors.py
              ;;
          esac
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.component }}-${{ matrix.platform }}
          path: |
            ui/build/
            daemon/dist/
            connectors/dist/
          retention-days: 7  # ç®€åŒ–ä¿ç•™ç­–ç•¥

  # ðŸ“Š æž„å»ºçŠ¶æ€æ±‡æ€» - æ›¿ä»£äº†å¤šä¸ªç‹¬ç«‹çš„summary jobs
  build-summary:
    name: ðŸ“Š Build Status Summary  
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-check, smart-build]
    if: always()
    
    steps:
      - name: Generate comprehensive summary
        run: |
          echo "## ðŸš€ Linch Mind Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.detect-changes.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Components Built**:" >> $GITHUB_STEP_SUMMARY
          
          # æ™ºèƒ½çŠ¶æ€æ£€æµ‹
          if [ "${{ needs.detect-changes.outputs.build_flutter }}" = "true" ]; then
            echo "- ðŸ“± **Flutter**: ${{ needs.smart-build.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.build_daemon }}" = "true" ]; then
            echo "- ðŸ”§ **Daemon**: ${{ needs.smart-build.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.build_connectors }}" = "true" ]; then
            echo "- ðŸ”Œ **Connectors**: ${{ needs.smart-build.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Checks**: ${{ needs.quality-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          
          # æ•´ä½“çŠ¶æ€
          if [ "${{ needs.quality-check.result }}" = "success" ] && [ "${{ needs.smart-build.result }}" = "success" ]; then
            echo "ðŸŽ‰ **Overall Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Overall Status**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Next Steps**: Review artifacts and consider deployment to staging" >> $GITHUB_STEP_SUMMARY