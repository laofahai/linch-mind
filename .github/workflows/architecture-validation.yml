name: ğŸ—ï¸ Architecture Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡æ¶æ„ä¸€è‡´æ€§
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"
  FLUTTER_VERSION: "3.32.0"

jobs:
  # éªŒè¯æŠ€æœ¯æ ˆç‰ˆæœ¬ä¸€è‡´æ€§
  validate-tech-stack:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Python version consistency
        run: |
          echo "ğŸ Validating Python version consistency..."

          # æ£€æŸ¥daemon/pyproject.tomlä¸­çš„Pythonç‰ˆæœ¬
          DAEMON_PYTHON=$(grep 'python = ' daemon/pyproject.toml | cut -d'"' -f2)
          echo "Daemon requires Python: $DAEMON_PYTHON"

          # æ£€æŸ¥CI/CDé…ç½®ä¸­çš„Pythonç‰ˆæœ¬
          CI_PYTHON="${{ env.PYTHON_VERSION }}"
          echo "CI/CD uses Python: $CI_PYTHON"

          # ç®€å•ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
          if [[ "$DAEMON_PYTHON" == *"$CI_PYTHON"* ]]; then
            echo "âœ… Python versions are compatible"
          else
            echo "âŒ Python version mismatch detected"
            echo "  Daemon: $DAEMON_PYTHON"
            echo "  CI/CD: $CI_PYTHON"
            exit 1
          fi

      - name: Validate Flutter version consistency
        run: |
          echo "ğŸ¯ Validating Flutter version consistency..."

          # æ£€æŸ¥ui/pubspec.yamlä¸­çš„Flutter SDKçº¦æŸ
          if [ -f "ui/pubspec.yaml" ]; then
            FLUTTER_CONSTRAINT=$(grep -A1 'environment:' ui/pubspec.yaml | grep 'flutter:' | cut -d':' -f2 | xargs)
            echo "UI Flutter constraint: $FLUTTER_CONSTRAINT"
          fi

          CI_FLUTTER="${{ env.FLUTTER_VERSION }}"
          echo "CI/CD uses Flutter: $CI_FLUTTER"

          echo "âœ… Flutter versions validated"

      - name: Validate dependency management consistency
        run: |
          echo "ğŸ“¦ Validating dependency management..."

          # æ£€æŸ¥Poetryé…ç½®
          if [ -f "daemon/pyproject.toml" ]; then
            echo "âœ… Found Poetry configuration in daemon/"
          else
            echo "âŒ Missing daemon/pyproject.toml"
            exit 1
          fi

          # æ£€æŸ¥Flutteré…ç½®
          if [ -f "ui/pubspec.yaml" ]; then
            echo "âœ… Found Flutter configuration in ui/"
          else
            echo "âŒ Missing ui/pubspec.yaml"
            exit 1
          fi

          # æ£€æŸ¥CMakeé…ç½®
          if [ -f "connectors/CMakeLists.txt" ] || [ -f "connectors/shared/CMakeLists.txt" ]; then
            echo "âœ… Found CMake configuration in connectors/"
          else
            echo "âŒ Missing CMake configuration in connectors/"
            exit 1
          fi

  # éªŒè¯æ¶æ„ç»„ä»¶å®Œæ•´æ€§
  validate-architecture-components:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate IPC architecture components
        run: |
          echo "ğŸ”— Validating IPC architecture..."

          # æ£€æŸ¥IPCæ ¸å¿ƒç»„ä»¶
          REQUIRED_IPC_FILES=(
            "daemon/services/ipc_server.py"
            "daemon/services/ipc_protocol.py"
            "daemon/services/ipc_client.py"
            "daemon/services/cross_platform_ipc.py"
          )

          for file in "${REQUIRED_IPC_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found $file"
            else
              echo "âŒ Missing $file"
              exit 1
            fi
          done

      - name: Validate environment isolation system
        run: |
          echo "ğŸ  Validating environment isolation..."

          # æ£€æŸ¥ç¯å¢ƒç®¡ç†æ ¸å¿ƒæ–‡ä»¶
          REQUIRED_ENV_FILES=(
            "daemon/core/environment_manager.py"
            "daemon/scripts/initialize_environment.py"
            "daemon/config/templates"
          )

          for file in "${REQUIRED_ENV_FILES[@]}"; do
            if [ -e "$file" ]; then
              echo "âœ… Found $file"
            else
              echo "âŒ Missing $file"
              exit 1
            fi
          done

      - name: Validate modern service architecture
        run: |
          echo "ğŸ—ï¸ Validating modern service architecture..."

          # æ£€æŸ¥ç°ä»£åŒ–æ¶æ„ç»„ä»¶
          REQUIRED_ARCH_FILES=(
            "daemon/core/service_facade.py"
            "daemon/core/error_handling.py"
            "daemon/core/container.py"
          )

          for file in "${REQUIRED_ARCH_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found $file"
            else
              echo "âŒ Missing $file"
              exit 1
            fi
          done

  # éªŒè¯æ•°æ®å­˜å‚¨æ¶æ„
  validate-data-architecture:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: "2.1.3"
          virtualenvs-create: true
          virtualenvs-in-project: false
          installer-parallel: true

      - name: Validate SQLite architecture
        run: |
          echo "ğŸ’¾ Validating SQLite data architecture..."
          cd daemon
          poetry install --no-interaction

          # æ£€æŸ¥SQLAlchemyé…ç½®
          if poetry run python -c "from sqlalchemy import __version__; print(f'SQLAlchemy version: {__version__}')"; then
            echo "âœ… SQLAlchemy available"
          else
            echo "âŒ SQLAlchemy not available"
            exit 1
          fi

          # æ£€æŸ¥SQLCipheræ”¯æŒ
          if poetry run python -c "import sqlcipher3; print('SQLCipher support available')"; then
            echo "âœ… SQLCipher support available"
          else
            echo "âš ï¸  SQLCipher support not available (acceptable for development)"
          fi

      - name: Validate AI/ML dependencies
        run: |
          echo "ğŸ¤– Validating AI/ML architecture..."
          cd daemon

          # æ£€æŸ¥FAISS
          if poetry run python -c "import faiss; print(f'FAISS version: {faiss.__version__}')"; then
            echo "âœ… FAISS available"
          else
            echo "âŒ FAISS not available"
            exit 1
          fi

          # æ£€æŸ¥NetworkX
          if poetry run python -c "import networkx as nx; print(f'NetworkX version: {nx.__version__}')"; then
            echo "âœ… NetworkX available"
          else
            echo "âŒ NetworkX not available"
            exit 1
          fi

          # æ£€æŸ¥Sentence Transformers
          if poetry run python -c "import sentence_transformers; print('Sentence Transformers available')"; then
            echo "âœ… Sentence Transformers available"
          else
            echo "âŒ Sentence Transformers not available"
            exit 1
          fi

  # éªŒè¯è·¨å¹³å°æ„å»ºæ”¯æŒ
  validate-cross-platform:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Validate platform-specific components
        shell: bash
        run: |
          echo "ğŸ–¥ï¸ Validating platform-specific components on ${{ matrix.os }}..."

          case "${{ matrix.os }}" in
            "ubuntu-latest")
              echo "Checking Linux-specific files..."
              if [ -f "daemon/services/cross_platform_ipc.py" ]; then
                echo "âœ… Unix Socket support available"
              fi
              ;;
            "macos-latest")
              echo "Checking macOS-specific files..."
              if [ -f "connectors/official/clipboard/src/platform/macos_clipboard.mm" ]; then
                echo "âœ… macOS clipboard support available"
              fi
              ;;
            "windows-latest")
              echo "Checking Windows-specific files..."
              if [ -f "daemon/services/windows_named_pipe.py" ]; then
                echo "âœ… Windows Named Pipe support available"
              fi
              if [ -f "connectors/official/clipboard/src/platform/windows_clipboard.cpp" ]; then
                echo "âœ… Windows clipboard support available"
              fi
              ;;
          esac

  # éªŒè¯æµ‹è¯•æ¶æ„å®Œæ•´æ€§
  validate-test-architecture:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate test structure
        run: |
          echo "ğŸ§ª Validating test architecture..."

          # æ£€æŸ¥Daemonæµ‹è¯•
          DAEMON_TEST_FILES=(
            "daemon/tests/test_core_components.py"
            "daemon/tests/test_ipc_integration.py"
            "daemon/tests/test_architecture_performance.py"
          )

          for file in "${DAEMON_TEST_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found $file"
            else
              echo "âš ï¸  Missing $file (may need creation)"
            fi
          done

          # æ£€æŸ¥UIæµ‹è¯•
          if [ -d "ui/test" ]; then
            echo "âœ… Found UI test directory"
            if [ -f "ui/test/widget_test.dart" ]; then
              echo "âœ… Found basic widget tests"
            fi
          fi

  # ç”Ÿæˆæ¶æ„éªŒè¯æŠ¥å‘Š
  generate-validation-report:
    needs: [
      validate-tech-stack,
      validate-architecture-components,
      validate-data-architecture,
      validate-cross-platform,
      validate-test-architecture
    ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Architecture Validation Summary
        run: |
          echo "ğŸ—ï¸ Architecture Validation Summary"
          echo "================================="
          echo ""
          echo "ğŸ“Š Validation Results:"
          echo "- Tech Stack Validation: ${{ needs.validate-tech-stack.result }}"
          echo "- Architecture Components: ${{ needs.validate-architecture-components.result }}"
          echo "- Data Architecture: ${{ needs.validate-data-architecture.result }}"
          echo "- Cross-Platform Support: ${{ needs.validate-cross-platform.result }}"
          echo "- Test Architecture: ${{ needs.validate-test-architecture.result }}"
          echo ""

          # ç»Ÿè®¡éªŒè¯ç»“æœ
          SUCCESS=0
          FAILURE=0

          RESULTS=(
            "${{ needs.validate-tech-stack.result }}"
            "${{ needs.validate-architecture-components.result }}"
            "${{ needs.validate-data-architecture.result }}"
            "${{ needs.validate-cross-platform.result }}"
            "${{ needs.validate-test-architecture.result }}"
          )

          for result in "${RESULTS[@]}"; do
            if [[ "$result" == "success" ]]; then
              SUCCESS=$((SUCCESS + 1))
            else
              FAILURE=$((FAILURE + 1))
            fi
          done

          echo "ğŸ“ˆ Overall Results: $SUCCESS/5 validations passed"

          if [ $FAILURE -eq 0 ]; then
            echo "âœ… All architecture validations passed!"
            echo "ğŸ¯ CI/CD configuration is fully aligned with project architecture"
          else
            echo "âŒ $FAILURE validation(s) failed"
            echo "ğŸ”§ CI/CD configuration needs adjustment to match project architecture"
            exit 1
          fi

      - name: Architecture recommendations
        if: always()
        run: |
          echo ""
          echo "ğŸ¯ Architecture Alignment Recommendations:"
          echo "========================================="
          echo "1. âœ… Pure IPC Architecture - No HTTP/REST APIs"
          echo "2. âœ… SQLite + SQLCipher - No PostgreSQL/MySQL"
          echo "3. âœ… Environment Isolation - ~/.linch-mind/{env}/"
          echo "4. âœ… Modern Service Architecture - ServiceFacade + DI"
          echo "5. âœ… Multi-language Build - Python + Flutter + C++"
          echo "6. âœ… AI/ML Ready - FAISS + NetworkX + Transformers"
          echo ""
          echo "ğŸ’¡ This validation ensures CI/CD scripts match the actual project architecture!"
